<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Nonlinear Parkour Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: url("https://raw.githubusercontent.com/m-gunuru/ClientProject/refs/heads/Test/ClientProject/front_end/image0.png") center center / cover no-repeat;
            font-family: "Press Start 2P", monospace;
            overflow: hidden;
        }
        #game-area {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        .character-img {
            position: absolute;
            width: 120px;
            height: auto;
            z-index: 2;
            user-select: none;
            pointer-events: none;
            transition: filter 0.2s;
            display: none;
        }
        .character-img.flipped {
            transform: scaleX(-1);
        }.platform {
    position: absolute;
    border-radius: 8px;
    z-index: 1;
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center center;
    border: none;
    overflow: visible; /* So bigger image can spill out */
}
.platform.img {
    background-image: url('https://raw.githubusercontent.com/ananya-k-a/ClientProject/refs/heads/main/ClientProject/front_end/2025_06_06_0u7_Kleki.png');
    transform: scale(1.15); /* Make image 15% bigger */
    pointer-events: none; /* So mouse events don't get weird */
}
.platform.teleport {
    background-image: url('https://raw.githubusercontent.com/ananya-k-a/ClientProject/refs/heads/main/ClientProject/front_end/2025_06_06_0u8_Kleki.png') !important;
    transform: scale(1.15);
    pointer-events: none;
}
        #settingsBtn {
            background: #3a4fa0;
            color: white;
            border: 2px solid #fff;
            border-radius: 8px;
            font-size: 1rem;
            font-family: "Press Start 2P", monospace;
            padding: 12px 34px;
            text-shadow: 3px 5px 1px #00000094;
            transition: background 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position:fixed;
            top:20px;
            right:20px;
            z-index:1000;
            min-width: 100px;
            cursor: pointer;
        }
        #settingsBtn:hover { background: #1d2558; }
        #settingsModal {
            display:none;
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            background:#3a4fa0;
            border-radius:10px;
            box-shadow:0 2px 8px rgba(0,0,0,0.3);
            z-index:2000;
            padding: 36px 40px 36px 40px;
            color:#fff;
            font-family: "Press Start 2P", monospace;
            min-width: 300px;
        }
        #settingsModal h2 { margin-top:0; }
        #settingsModal input[type="range"]{ width: 160px;}
        #settingsModal .button {
            background: #1d2558;
            color: white;
            border: 2px solid #fff;
            border-radius: 8px;
            font-size: 1rem;
            font-family: "Press Start 2P", monospace;
            padding: 8px 20px;
            margin: 8px 6px 0 0;
            cursor:pointer;
        }
        #settingsModal .button:hover { background: #3a4fa0; }
        @media (max-width: 600px) {
            .character-img { width: 80px; }
            #settingsModal { min-width: 180px; padding: 18px 8vw 18px 8vw; }
        }
    </style>
</head>
<body>
    <audio id="bg-music" preload="auto" loop>
      <source src="Pokemon BW2 Iris Battle Remix.mp3" type="audio/mpeg">
    </audio>
    <div id="game-area">
        <!-- Animated Character GIF -->
        <img 
            id="character-gif"
            class="character-img"
            src="https://raw.githubusercontent.com/ananya-k-a/ClientProject/refs/heads/main/ClientProject/front_end/output-onlinegiftools.gif" 
            alt="Character Animated"
        />
        <!-- Static Character PNG (for pausing) -->
        <img 
            id="character-png"
            class="character-img"
            src="https://raw.githubusercontent.com/ananya-k-a/ClientProject/refs/heads/main/ClientProject/front_end/2025_06_06_0tl_Kleki.png" 
            alt="Character Static"
        />
        <!-- Platforms will be injected here -->
    </div>
    <!-- Settings Button -->
    <button id="settingsBtn">Settings</button>
    <!-- Settings Modal -->
    <div id="settingsModal">
        <h2>Settings</h2>
        <label for="volumeSlider">Volume:</label>
        <input type="range" id="volumeSlider" min="0" max="100" step="1"><span id="volumeValue"></span>%
        <br><br>
        <button id="saveSettingsBtn" class="button">Save</button>
        <button id="closeSettingsBtn" class="button">Close</button>
    </div>
    <script>
    // --- Music & Settings Logic ---
    window.onload = function() {
        let musicStarted = false;
        function tryPlayMusic() {
            if (!musicStarted) {
                document.getElementById('bg-music').play().catch(()=>{});
                musicStarted = true;
            }
        }
        window.addEventListener('keydown', tryPlayMusic, { once: true });
        window.addEventListener('mousedown', tryPlayMusic, { once: true });

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('gameSettings')) || { volume: 100 };
            document.getElementById('volumeSlider').value = settings.volume;
            document.getElementById('volumeValue').textContent = settings.volume;
            document.getElementById('bg-music').volume = settings.volume / 100;
            return settings;
        }
        function saveSettings() {
            const volume = parseInt(document.getElementById('volumeSlider').value, 10);
            localStorage.setItem('gameSettings', JSON.stringify({ volume }));
            alert('Settings saved!');
        }
        const modal = document.getElementById('settingsModal');
        document.getElementById('settingsBtn').onclick = function() {
            modal.style.display = 'block';
            loadSettings();
        };
        document.getElementById('closeSettingsBtn').onclick = function() {
            modal.style.display = 'none';
        };
        document.getElementById('saveSettingsBtn').onclick = function() {
            saveSettings();
            modal.style.display = 'none';
        };
        document.getElementById('volumeSlider').oninput = function() {
            document.getElementById('volumeValue').textContent = this.value;
            document.getElementById('bg-music').volume = this.value / 100;
        };
        loadSettings();
    };

    // --- Game & Platform Logic ---
    const charGif = document.getElementById('character-gif');
    const charPng = document.getElementById('character-png');
    const charWidth = 120;
    const charHeight = 120;
    const gameArea = document.getElementById('game-area');

    // --- GROUND HEIGHT: Adjust here ---
    const groundHeight = 100; // pixels from bottom

    // Platform format: [x, y, width, height, isTeleport]
    const platforms = [
        [130, 200, 120, 25, false],         // Start (reachable from ground)
        [320, 350, 120, 25, false],         // up right (higher)
        [600, 380, 120, 25, false],         // mid right (higher)
        [800, 420, 120, 25, false],         // high right (higher)
        [950, 570, 120, 25, false],         // high up (higher)
        [1200, 350, 120, 25, true]          // blue teleport pad (higher)
    ];
    let startPlatformIdx = 0;

    // For moving platforms (per-platform speed, amplitude, phase)
    const platformOffsets = new Array(platforms.length).fill(0);
    const platformSpeeds = [0, 1.2, 0.7, 1.4, 0.9, 1.1];
    const platformAmplitudes = [0, 40, 25, 55, 30, 50];
    const platformPhases = [0, 0, Math.PI/3, Math.PI/5, Math.PI/2, Math.PI];

    const HITBOX_SHRINK = 20; // How much to shrink (px)
function drawPlatforms() {
    Array.from(document.getElementsByClassName('platform')).forEach(e=>e.remove());
    for (let i=0; i<platforms.length; i++) {
        const [x, y, w, h, isTeleport] = platforms[i];
        let pf = document.createElement('div');
        pf.className = 'platform img' + (isTeleport ? ' teleport' : '');
        pf.style.left = (x + HITBOX_SHRINK/2) + 'px'; // Center the hitbox under the image
        pf.style.bottom = y+'px';
        pf.style.width = (w - HITBOX_SHRINK) + 'px'; // Shrink hitbox width
        pf.style.height = h+'px';
        pf.dataset.idx = i;
        gameArea.appendChild(pf);
    }
}
    drawPlatforms();

    function updatePlatforms() {
        const t = performance.now() / 1000; // seconds
        for (let i = 0; i < platforms.length; i++) {
            if (i === 0) continue; // static
            platformOffsets[i] = Math.sin(t * platformSpeeds[i] + platformPhases[i]) * platformAmplitudes[i];
            const platformEl = document.querySelector('.platform[data-idx="'+i+'"]');
            if (platformEl) {
                platformEl.style.bottom = (platforms[i][1] + platformOffsets[i]) + 'px';
            }
        }
    }

    // --- Character Movement Logic ---
    let pos = { x: platforms[startPlatformIdx][0]+10, y: platforms[startPlatformIdx][1]+platforms[startPlatformIdx][3] };
    let velocity = { x: 0, y: 0 };
    let move = { left: false, right: false, jump: false };
    let onGround = false;
    let lastDirection = "right";
    const speed = 5;
    const jumpStrength = 17;
    const gravity = 0.9;

    let prevStandingPlatform = null;

    function getStandingPlatform() {
        for(let i=0; i<platforms.length; i++) {
            const [x, y, w, h, isTeleport] = platforms[i];
            const offsetY = (platformOffsets[i] || 0);
            // Make the landing band wider (more forgiving)
            if (
                pos.x + charWidth > x + 5 && pos.x < x + w - 5 &&
                pos.y - 2 <= y + h + offsetY && pos.y - 2 >= y + h + offsetY - 30
            ) {
                // If it's a cloud (not teleport), sink in by 8px
                const sink = isTeleport ? 0 : 8;
                return [i, y + h + offsetY - sink];
            }
        }
        if (pos.y <= groundHeight + 2 && pos.y >= groundHeight - 20) {
            return ['ground', groundHeight];
        }
        return null;
    }

    function getLowestPlatformY() {
        let minY = Infinity;
        for (let p of platforms) if (p[1] < minY) minY = p[1];
        return minY;
    }

    function resetToStart() {
        pos.x = platforms[startPlatformIdx][0]+10;
        pos.y = platforms[startPlatformIdx][1]+platforms[startPlatformIdx][3];
        velocity.x = 0;
        velocity.y = 0;
    }

    function updateCharPosition() {
        // Horizontal movement
        velocity.x = 0;
        if (move.left) velocity.x = -speed;
        else if (move.right) velocity.x = speed;
        // Vertical movement (jump and gravity)
        if (move.jump && onGround) {
            velocity.y = jumpStrength;
            onGround = false;
        }
        velocity.y -= gravity;

        pos.x += velocity.x;
        pos.y += velocity.y;

        // --- Collision with ground/platforms (vertical, landing only, no head collision) ---
        let standing = getStandingPlatform();
        // If standing on a moving platform, move character with it
        if (typeof standing?.[0] === "number" && standing[0] !== 0) {
            const deltaY = (platformOffsets[standing[0]] || 0) - (platformOffsets[prevStandingPlatform] || 0);
            if (onGround) pos.y += deltaY;
        }
        prevStandingPlatform = standing ? standing[0] : null;
        if (standing && velocity.y <= 0 && pos.y <= standing[1]) {
            pos.y = standing[1];
            velocity.y = 0;
            onGround = true;

            // Teleport logic
            if (typeof standing[0] === "number" && platforms[standing[0]][4]) {
                window.location.href = "fightDialogue.html";
            }
        } else {
            onGround = false;
        }

        // Boundaries
        const rightBound = window.innerWidth - charWidth;
        if (pos.x < 0) pos.x = 0;
        if (pos.x > rightBound) pos.x = rightBound;

        // Fall reset
        let resetY = Math.min(groundHeight, getLowestPlatformY() - 80);
        if (pos.y < resetY) {
            resetToStart();
        }

        // Top boundary
        const ceiling = window.innerHeight - 80;
        if (pos.y > ceiling) pos.y = ceiling;

        // Apply position
        charGif.style.left = charPng.style.left = pos.x + 'px';
        charGif.style.bottom = charPng.style.bottom = pos.y + 'px';
    }

    // --- GIF Pause/Play Logic (show PNG if not moving left/right) ---
    function updateCharacterFrame() {
        if (move.left || move.right) {
            charGif.style.display = 'block';
            charPng.style.display = 'none';
        } else {
            charGif.style.display = 'none';
            charPng.style.display = 'block';
        }
        // Apply flipping
        if (lastDirection === "left") {
            charGif.classList.add('flipped');
            charPng.classList.add('flipped');
        } else {
            charGif.classList.remove('flipped');
            charPng.classList.remove('flipped');
        }
    }

    function gameLoop() {
        updatePlatforms();
        updateCharPosition();
        updateCharacterFrame();
        requestAnimationFrame(gameLoop);
    }
    gameLoop();

    // --- Keyboard Controls ---
    window.addEventListener('keydown', function(e) {
        if (["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) return;
        switch(e.key.toLowerCase()) {
            case "a":
                move.left = true;
                lastDirection = "left";
                break;
            case "d":
                move.right = true;
                lastDirection = "right";
                break;
            case " ": move.jump = true; break;
        }
    });
    window.addEventListener('keyup', function(e) {
        switch(e.key.toLowerCase()) {
            case "a":
                move.left = false;
                if (move.right) {
                    lastDirection = "right";
                }
                break;
            case "d":
                move.right = false;
                if (move.left) {
                    lastDirection = "left";
                }
                break;
            case " ": move.jump = false; break;
        }
    });

    // --- Responsive resize ---
    window.addEventListener('resize', ()=>{
        const rightBound = window.innerWidth - charWidth;
        if(pos.x > rightBound) pos.x = rightBound;
        charGif.style.left = charPng.style.left = pos.x + "px";
    });
    </script>
</body>
</html>
